# 댓글 정렬 필드 추가 계획

## 배경/문제
- 댓글 이동 기능이 현재 `createdAt`을 조정해 정렬을 변경한다.
- 이로 인해 실제 생성 시각과 표시 순서가 불일치하여 혼란이 발생한다.
- “최하단 답글” 판단도 `createdAt` 기준이라 사용자 인지와 다를 수 있다.

## 목표
- `createdAt`은 생성 시각으로 유지한다.
- 댓글 정렬용 전용 필드(`orderIndex` 등)를 도입해 이동/정렬을 처리한다.
- “같은 부모 기준 최하단” 판단이 화면 표시와 일치하도록 만든다.

## 범위
- 포함 범위
  - DB 스키마에 정렬 필드 추가 및 데이터 마이그레이션
  - 정렬/이동 로직을 정렬 필드 기준으로 변경
  - 프론트 정렬 및 캐시 갱신 로직 반영
- 제외 범위
  - 댓글 권한/신고 등 부가 기능 변경
  - 전체 정렬 정책(최신순/인기순) 자체 변경

## 현재 동작 정리
- 댓글 목록은 `createdAt` 오름차순으로 조회된다.
- 프론트는 부모-자식 관계를 구성하고 DFS로 출력한다.
- 이동 시 `createdAt`을 조정해 순서를 바꾼다.

## 개선 방향
- `createdAt`과 무관한 정렬 전용 필드를 사용한다.
- 동일 부모 내 정렬은 `orderIndex`(오름차순) 기준으로 유지한다.
- 이동은 `orderIndex` 갱신으로 처리하고, 경계/승격 규칙은 동일하게 적용한다.

## 단계별 계획
- 1단계: 스키마 설계 및 마이그레이션
  - `entries`에 `order_index` 컬럼 추가
  - 기존 데이터는 `created_at` 순으로 `order_index` 초기화
  - 완료 기준: 마이그레이션 적용 후 기존 순서 유지
- 2단계: 서버 조회/정렬 변경
  - 조회 쿼리를 `order_index` 기준으로 변경
  - 이동 로직에서 `order_index` 조정 규칙 적용
  - 완료 기준: 이동 후 순서가 `createdAt`과 무관하게 유지됨
- 3단계: 프론트 정렬 및 캐시 반영
  - `createdAt` 대신 `orderIndex` 기반으로 정렬 로직 변경
  - 이동 응답 시 `orderIndex` 갱신 반영
  - 완료 기준: 화면 순서와 이동 판단이 일치
- 4단계: 검증 및 경계 조건 확인
  - 최상단/최하단/최상단 답글/최하단 답글 이동 시나리오 검증
  - 완료 기준: 규칙대로 승격/무동작 처리됨

## 리스크 및 대응
- 정렬 필드 충돌/중복으로 순서가 불안정해질 수 있음
  - 대응: 이동 시 인접 값 재할당 또는 범위 재정렬 로직 도입
- 대량 데이터에서 재정렬 비용 증가
  - 대응: 최소 범위 재정렬, 필요 시 배치 재정렬 제공
1
## 검증 계획
- 기존 스레드에서 순서가 유지되는지 확인
- 이동 후 `createdAt`이 변하지 않는지 확인
- 동일 부모 기준 최하단 답글 판정이 화면과 일치하는지 확인
