# 스키마 무결성/인덱스 개선 계획

## 배경/문제
- 현재 스키마는 핵심 도메인 테이블 수는 적절하지만, FK/인덱스 부족으로 무결성 및 성능 리스크가 존재한다.
- 사용자 소유자 관계가 `owner_username` 문자열에 의존하고 있어 변경/삭제 시 정합성 보장이 어렵다.

## 목표
- 스레드/카테고리/엔트리의 무결성을 DB 레벨에서 보장한다.
- 조인 테이블 및 자주 조회되는 컬럼에 인덱스를 추가해 조회 성능을 개선한다.
- 소유자 참조 모델을 명확히 하여 데이터 정합성 및 유지보수성을 높인다.

## 범위
- 포함: JPA 엔티티/리포지토리, 스키마 마이그레이션, 인덱스 추가
- 제외: 대규모 데이터 마이그레이션/백필 스크립트, 성능 벤치마크 자동화

## 현재 동작 정리
- `threads.owner_username`, `categories.owner_username`는 FK가 없는 문자열 컬럼이다.
- `thread_categories`는 기본 네이밍/제약에 의존한다.
- `entries.parent_entry_id`는 FK가 없고 앱 로직으로만 정합성을 보장한다.
- 주요 조회 패턴(`owner_username`, `last_activity_at`, `created_at`)에 대해 명시 인덱스가 없다.

## 개선 방향
- 가능하면 `users.id` 기반 FK로 소유자 참조를 정규화한다.
- 조인 테이블 컬럼/제약을 명시해 중복/오염을 방지한다.
- 엔트리 부모 관계에 FK를 추가해 무결성을 강화한다.
- 조회 패턴에 맞춘 인덱스를 추가한다.

## 단계별 계획
- 1단계: 스키마 변경 설계 확정
  - 무엇을 변경: 소유자 참조 컬럼/조인 테이블/인덱스 변경 설계
  - 완료 기준: 변경 대상 컬럼/제약/인덱스 목록과 적용 순서 확정
- 2단계: 엔티티/리포지토리 수정
  - 무엇을 변경: JPA 매핑(예: FK 컬럼, 조인 테이블 명시)
  - 완료 기준: 코드에서 명시적 매핑/제약 반영
- 3단계: 마이그레이션 추가
  - 무엇을 변경: DB 스키마 변경 SQL/마이그레이션 스크립트
  - 완료 기준: 신규 스키마가 DB에 적용 가능
- 4단계: 검증
  - 무엇을 변경: 없음
  - 완료 기준: 주요 API 동작/권한 검증 통과

## 리스크 및 대응
- 소유자 컬럼 변경 시 데이터 마이그레이션 필요 → 변환 스크립트 및 롤백 계획 수립
- FK 추가 시 기존 데이터 위반 가능 → 사전 데이터 검증 쿼리로 리스크 확인

## 검증 계획
- 자동: 스키마 변경 후 애플리케이션 구동 및 주요 API 동작 확인
- 수동: 스레드/엔트리/카테고리 CRUD, 사용자 간 접근 차단 확인
