# 플라이웨이 도입 및 소유자 FK 전환 계획

## 배경/문제
- 운영 환경(`ddl-auto: none`)에서는 스키마 변경이 자동 반영되지 않아 마이그레이션 관리가 필요하다.
- 현재 `owner_username` 기반 참조는 사용자명 변경/삭제 시 무결성 문제가 발생할 수 있다.

## 목표
- Flyway를 도입해 스키마 변경을 버전 관리한다.
- `threads`/`categories`의 소유자 참조를 `users.id` 기반 FK로 전환한다.
- 기존 인덱스/조인 테이블 변경 사항을 마이그레이션으로 적용한다.

## 범위
- 포함: Flyway 설정, 마이그레이션 SQL, 엔티티/리포지토리/서비스 수정
- 제외: 대규모 데이터 백필 자동화, 롤백 자동 스크립트(수동 가이드 제공)

## 현재 동작 정리
- 소유자 식별자는 문자열 `owner_username` 컬럼으로 관리된다.
- JPA 인덱스는 엔티티에 추가했지만 운영 반영은 별도 마이그레이션이 필요하다.
- DB 마이그레이션 도구가 없다.

## 개선 방향
- Flyway로 마이그레이션 버전/순서를 관리한다.
- `users.id`를 FK로 참조하는 `owner_id` 컬럼 도입 후 점진적 전환.
- 기존 `owner_username`은 호환 단계에서 유지 후 제거 여부 결정.

## 단계별 계획
- 1단계: Flyway 도입
  - 무엇을 변경: 의존성 추가, 설정 추가, 마이그레이션 디렉터리 구성
  - 완료 기준: 애플리케이션 부팅 시 Flyway가 동작
- 2단계: 스키마 마이그레이션 추가
  - 무엇을 변경: 인덱스 생성, 조인 테이블 명시, `owner_id` 추가
  - 완료 기준: 신규 마이그레이션이 DB에 적용 가능
- 3단계: 코드 전환
  - 무엇을 변경: 엔티티/리포지토리/서비스에서 `owner_id` 사용
  - 완료 기준: 주요 API가 `owner_id` 기준으로 동작
- 4단계: 정리 및 문서화
  - 무엇을 변경: `owner_username` 유지/제거 정책 문서화
  - 완료 기준: 마이그레이션/운영 가이드 정리

## 리스크 및 대응
- 기존 데이터에 `owner_id`가 비어 있을 수 있음 → 사전 매핑 SQL로 채움
- FK 추가 시 위반 데이터 존재 가능 → 적용 전 점검 쿼리 제공

## 검증 계획
- 자동: 애플리케이션 기동 및 주요 API 호출 확인
- 수동: 사용자별 접근 차단, 스레드/엔트리/카테고리 CRUD 검증
