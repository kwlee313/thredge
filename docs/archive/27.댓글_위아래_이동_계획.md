# 댓글 위아래 이동 계획

## 배경/문제
- 스레드 댓글이 시간순으로 나열되고, 답글도 계층 구조로 표시된다.
- 사용자가 댓글의 위치를 바꾸려면 삭제/재작성 또는 복잡한 조작이 필요하다.
- “위로 이동” 동작이 단순 정렬 변경이 아니라 답글 계층까지 재구성해야 하므로 명확한 규칙이 필요하다.

## 목표
- 각 댓글에 위/아래 이동 버튼을 제공한다.
- “위로 이동”을 누르면 해당 댓글이 바로 위 댓글의 답글이 된다.
- 만약 해당 댓글이 현재 부모 댓글의 최상단 답글이면, 한 번 더 “위로 이동” 시 부모가 부모의 위쪽 댓글로 변경된다.
- 사용자 입장에서 예측 가능한 계층 이동 경험을 제공한다.
- 답글이 달린 답글은 이동 대상에서 제외한다.
- 최상단/최하단 답글에서 위/아래 이동 시 답글이 댓글(루트)로 전환된다.
- 최상단/최하단 댓글에서 위/아래 이동 시 무동작 처리한다.

## 범위
- 포함 범위
  - 댓글/답글 계층 이동 규칙 정의 및 구현
  - 댓글 리스트 UI에 위/아래 버튼 추가
  - 이동 API 및 서버 로직 구현
  - 이동 불가 조건(자식 보유 답글, 최상단/최하단 경계) 처리
- 제외 범위
  - 댓글 정렬 기준(최신순/인기순) 자체 변경
  - 댓글 권한/신고 등 부가 기능 변경

## 현재 동작 정리
- 댓글은 계층 구조(부모-자식)로 저장된다.
- 정렬 기준에 따라 댓글과 답글이 렌더링된다.
- 댓글의 부모 변경 기능은 현재 제공되지 않는다.

## 개선 방향
- 이동 동작을 “부모 변경 + 동일 부모 내 위치 조정”으로 모델링한다.
- 계층 이동 규칙을 명문화하고, 엣지 케이스(최상단 댓글, 최상단 답글)를 안전하게 처리한다.
- 서버에서 원자적으로 이동을 처리하여 일관성을 보장한다.
- 자식이 있는 답글은 이동을 금지하여 트리 손상을 방지한다.
- 경계 이동(최상단/최하단)의 결과를 “루트 전환 또는 무동작”으로 고정한다.

## 단계별 계획
- 1단계: 동작 규칙 및 데이터 구조 확인
  - 댓글 테이블/스키마의 부모 참조, 정렬 필드, 동일 부모 내 순서 필드 확인
  - “자식 보유 답글 이동 금지”, “경계 이동 시 루트 전환/무동작” 규칙 문서화
  - 완료 기준: 이동에 필요한 필드와 제약이 문서화됨
- 2단계: 서버 이동 API 설계 및 구현
  - “위/아래 이동” 요청을 처리할 엔드포인트 추가
  - 이동 규칙(부모 변경/순서 변경)과 경계 조건 처리
  - 자식 보유 답글 이동 요청 거부 처리
  - 완료 기준: 단위/통합 테스트 또는 최소 수동 검증으로 동작 확인
- 3단계: 프론트엔드 UI 적용
  - 댓글 아이템에 위/아래 버튼 추가
  - 이동 성공 시 목록 갱신
  - 이동 불가 상태(비활성화/툴팁) 표시
  - 완료 기준: UI에서 이동 버튼으로 계층 변화가 반영됨
- 4단계: 예외/권한/검증 보강
  - 작성자/권한 확인 및 불가 조건 표시
  - 실패 메시지 및 롤백 처리
  - 완료 기준: 오류 케이스가 사용자에게 명확히 노출됨

## 리스크 및 대응
- 계층 이동으로 인해 정렬/중복 문제 발생 가능
  - 대응: 이동 시 부모/순서 필드 업데이트를 트랜잭션으로 처리
- 최상단 댓글 이동 시 범위 이탈
  - 대응: 이동 불가 처리 및 UI 비활성화
- 최상단/최하단 답글 이동 시 루트 전환 혼란
  - 대응: 명확한 UI 안내(툴팁/토스트) 제공
- 경쟁 조건(동시 이동)
  - 대응: 서버에서 잠금 또는 재정렬 로직 적용

## 검증 계획
- 댓글/답글 각각에서 위/아래 이동을 수동 테스트
- 최상단/최하단/최상단 답글에서 경계 동작 확인
- 자식이 있는 답글 이동 시 불가 처리 확인
- 이동 후 새 부모 및 순서가 기대대로 반영되는지 확인
